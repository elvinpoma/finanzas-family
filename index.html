<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FamilyWealth Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #000; color: #f5f5f7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        .ios-card { background: #1C1C1E; border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 16px; }
        .ios-input { background: #2C2C2E; border: 1px solid #3A3A3C; border-radius: 12px; padding: 12px; color: white; width: 100%; outline: none; transition: 0.2s; }
        .ios-input:focus { border-color: #0A84FF; background: #323234; }
        .btn-action { background: #0A84FF; color: white; border-radius: 12px; padding: 14px; font-weight: 600; width: 100%; }
        .btn-action:active { opacity: 0.8; transform: scale(0.98); }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, createContext, useContext, useRef } = React;

        const Icon = ({ name, size = 18, className="" }) => {
            useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [data, setData] = useState({ txs: [], subs: [], goals: [] });

            // LOGIN
            const login = (password) => {
                try {
                    const encrypted = localStorage.getItem('fw_db_v5');
                    if (!encrypted) {
                        const init = { txs: [], subs: [], goals: [] };
                        setUser({ key: password }); setData(init); save(init, password);
                        return true;
                    }
                    const bytes = CryptoJS.AES.decrypt(encrypted, password);
                    const dec = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    setUser({ key: password }); setData(dec || { txs: [], subs: [], goals: [] });
                    return true;
                } catch (e) { return false; }
            };

            const save = (newData, key = user?.key) => {
                if(!key) return;
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(newData), key).toString();
                localStorage.setItem('fw_db_v5', encrypted);
            };

            // CRUD
            const add = (key, item) => { const n = {...data, [key]: [{...item, id: Date.now()}, ...data[key]]}; setData(n); save(n); };
            const del = (key, id) => { const n = {...data, [key]: data[key].filter(i => i.id !== id)}; setData(n); save(n); };

            // SISTEMA DE ARCHIVOS (IMPORTAR / EXPORTAR)
            const exportData = () => {
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `FW_Backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const importData = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.txs && json.subs) {
                            setData(json);
                            save(json);
                            alert("‚úÖ Datos importados correctamente.");
                        } else {
                            alert("‚ö†Ô∏è El archivo no es v√°lido.");
                        }
                    } catch (err) { alert("‚ùå Error al leer el archivo."); }
                };
                reader.readAsText(file);
            };

            return (
                <AppContext.Provider value={{ user, login, data, add, del, exportData, importData }}>
                    {children}
                </AppContext.Provider>
            );
        };

        // --- COMPONENTE: SIMULADOR INTUITIVO (NUEVO) ---
        const SmartSimulator = () => {
            const [amount, setAmount] = useState(15000);
            const [months, setMonths] = useState(48);
            const [rate, setRate] = useState(6.5);
            const [type, setType] = useState('auto'); // home, auto, personal

            // Presets de Intereses (Aproximados de mercado)
            const presets = {
                home: { r: 3.5, label: 'Hipoteca', icon: 'home' },
                auto: { r: 6.5, label: 'Coche', icon: 'car' },
                card: { r: 12.0, label: 'Personal', icon: 'credit-card' }
            };

            const setPreset = (k) => {
                setType(k); setRate(presets[k].r);
                // Ajustar a√±os l√≥gicos por defecto
                if(k === 'home') setMonths(300); // 25 a√±os
                if(k === 'auto') setMonths(48);  // 4 a√±os
                if(k === 'card') setMonths(24);  // 2 a√±os
            };

            // C√°lculo
            const r = (rate / 100) / 12;
            const cuota = amount * ((r * Math.pow(1+r, months)) / (Math.pow(1+r, months) - 1));
            const totalPagado = cuota * months;
            const totalInteres = totalPagado - amount;
            const porcInteres = (totalInteres / totalPagado) * 100;

            return (
                <div className="ios-card bg-gray-900 border border-orange-500/30">
                    <h3 className="text-orange-500 font-bold mb-4 flex gap-2 items-center"><Icon name="calculator"/> Simulador Pr√©stamo</h3>
                    
                    {/* Botones de Tipo */}
                    <div className="flex gap-2 mb-4 bg-black/40 p-1 rounded-xl">
                        {Object.entries(presets).map(([k, v]) => (
                            <button key={k} onClick={() => setPreset(k)} 
                                className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all flex flex-col items-center gap-1
                                ${type === k ? 'bg-orange-500 text-white shadow-lg' : 'text-gray-500 hover:bg-white/5'}`}>
                                <Icon name={v.icon} size={16} />
                                {v.label}
                            </button>
                        ))}
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label className="text-[10px] text-gray-400 uppercase font-bold">Solicito (‚Ç¨)</label>
                            <input type="number" value={amount} onChange={e=>setAmount(Number(e.target.value))} className="ios-input text-center font-bold text-lg"/>
                        </div>
                        <div>
                            <label className="text-[10px] text-gray-400 uppercase font-bold">Meses</label>
                            <input type="number" value={months} onChange={e=>setMonths(Number(e.target.value))} className="ios-input text-center font-bold text-lg"/>
                        </div>
                    </div>

                    {/* Resultado Visual */}
                    <div className="bg-black/40 p-4 rounded-xl text-center mb-2">
                        <p className="text-xs text-gray-400 mb-1">Cuota Mensual Estimada</p>
                        <p className="text-3xl font-bold text-white">{cuota.toFixed(2)}‚Ç¨</p>
                        <p className="text-[10px] text-orange-400 mt-1">Inter√©s aplicado: {rate}%</p>
                    </div>

                    {/* Barra de "Dolor" (Intereses vs Capital) */}
                    <div className="mt-4">
                        <div className="flex justify-between text-[10px] mb-1">
                            <span className="text-green-400">Capital Real ({amount}‚Ç¨)</span>
                            <span className="text-red-400">Intereses ({totalInteres.toFixed(0)}‚Ç¨)</span>
                        </div>
                        <div className="h-3 bg-gray-700 rounded-full overflow-hidden flex">
                            <div style={{width: `${100-porcInteres}%`}} className="bg-green-500 h-full"></div>
                            <div style={{width: `${porcInteres}%`}} className="bg-red-500 h-full"></div>
                        </div>
                        <p className="text-[10px] text-gray-500 text-center mt-2">
                            Devolver√°s un total de <b>{totalPagado.toFixed(0)}‚Ç¨</b>
                        </p>
                    </div>
                </div>
            );
        };

        // --- LOGIN ---
        const Login = () => {
            const { login } = useContext(AppContext);
            const [p, setP] = useState('');
            return (
                <div className="h-screen flex flex-col items-center justify-center p-6 bg-black">
                    <div className="w-16 h-16 bg-gray-800 rounded-2xl flex items-center justify-center mb-6"><Icon name="lock" color="#0A84FF" size={32}/></div>
                    <h1 className="text-2xl font-bold mb-8">FamilyWealth</h1>
                    <input type="password" value={p} onChange={e=>setP(e.target.value)} placeholder="Contrase√±a" className="ios-input text-center text-xl mb-4 w-64"/>
                    <button onClick={()=>login(p)} className="btn-action w-64">Entrar</button>
                </div>
            );
        };

        // --- DASHBOARD ---
        const Dashboard = () => {
            const { data, add, del, exportData, importData } = useContext(AppContext);
            const [form, setForm] = useState({ desc: '', amount: '', type: 'out', cat: 'üçî' });
            const fileInputRef = useRef(null);

            const balance = data.txs.reduce((acc, t) => acc + (t.type==='in'?t.amount:-t.amount), 0);

            // Importar archivo
            const handleFile = (e) => {
                if(e.target.files[0]) importData(e.target.files[0]);
            };

            return (
                <div className="pb-32 max-w-xl mx-auto min-h-screen">
                    {/* Header con Men√∫ de Archivos */}
                    <div className="p-6 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur z-20">
                        <span className="font-bold text-lg">FamilyWealth</span>
                        <div className="flex gap-2">
                            <button onClick={()=>fileInputRef.current.click()} className="p-2 bg-gray-800 rounded-full text-blue-400"><Icon name="upload-cloud" size={20}/></button>
                            <button onClick={exportData} className="p-2 bg-gray-800 rounded-full text-green-400"><Icon name="download-cloud" size={20}/></button>
                            <input type="file" ref={fileInputRef} onChange={handleFile} className="hidden" accept=".json"/>
                        </div>
                    </div>

                    <div className="px-6 text-center mb-6">
                        <p className="text-xs font-bold text-gray-500 uppercase">Patrimonio Neto</p>
                        <h1 className="text-5xl font-bold text-white my-2">{balance.toFixed(2)}‚Ç¨</h1>
                    </div>

                    <div className="px-4 space-y-4">
                        {/* Formulario R√°pido */}
                        <div className="ios-card bg-gray-900/80 backdrop-blur border-blue-500/20 border">
                            <div className="flex gap-2 mb-3">
                                <button onClick={()=>setForm({...form, type:'in'})} className={`flex-1 py-2 rounded-lg text-xs font-bold ${form.type==='in'?'bg-green-600':'bg-gray-800 text-gray-400'}`}>INGRESO</button>
                                <button onClick={()=>setForm({...form, type:'out'})} className={`flex-1 py-2 rounded-lg text-xs font-bold ${form.type==='out'?'bg-red-600':'bg-gray-800 text-gray-400'}`}>GASTO</button>
                            </div>
                            <div className="flex gap-2 mb-3">
                                <input placeholder="Concepto" value={form.desc} onChange={e=>setForm({...form, desc:e.target.value})} className="ios-input flex-1"/>
                                <input type="number" placeholder="0.00" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} className="ios-input w-24 text-center"/>
                            </div>
                            {form.type === 'out' && (
                                <div className="flex gap-2 overflow-x-auto hide-scroll pb-2 mb-2">
                                    {['üçî','üè†','üöó','üéâ','üíä','üõçÔ∏è','üêæ'].map(emoji => (
                                        <button key={emoji} onClick={()=>setForm({...form, cat:emoji})} className={`p-3 rounded-xl text-xl transition-all ${form.cat===emoji?'bg-white/20 scale-110':'bg-white/5 opacity-50'}`}>{emoji}</button>
                                    ))}
                                </div>
                            )}
                            <button onClick={()=>{if(form.desc && form.amount) {add('txs', {...form, amount: parseFloat(form.amount)}); setForm({...form, desc:'', amount:''})}}} className="btn-action bg-white text-black hover:bg-gray-200">A√±adir</button>
                        </div>

                        {/* Nuevo Simulador */}
                        <SmartSimulator />

                        {/* Historial */}
                        <div className="ios-card">
                            <h3 className="text-xs font-bold text-gray-500 mb-4 uppercase">Movimientos</h3>
                            <div className="space-y-3">
                                {data.txs.slice(0, 10).map(t => (
                                    <div key={t.id} className="flex justify-between items-center bg-black/20 p-2 rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <div className="text-2xl">{t.type==='in'?'üí∞':t.cat}</div>
                                            <div><p className="font-bold text-sm">{t.desc}</p></div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <span className={`font-mono font-bold ${t.type==='in'?'text-green-400':'text-white'}`}>{t.type==='in'?'+':'-'}{t.amount}‚Ç¨</span>
                                            <button onClick={()=>del('txs', t.id)} className="text-gray-600"><Icon name="trash-2" size={14}/></button>
                                        </div>
                                    </div>
                                ))}
                                {data.txs.length===0 && <p className="text-center text-gray-500 text-xs">Sin datos</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppProvider><AppContext.Consumer>{({user}) => user ? <Dashboard/> : <Login/>}</AppContext.Consumer></AppProvider>);
    </script>
</body>
</html>
