<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FamilyWealth</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#000000',
                        card: '#1C1C1E',
                        primary: '#0A84FF', // iOS Blue
                        success: '#30D158', // iOS Green
                        danger: '#FF453A',  // iOS Red
                        warning: '#FF9F0A', // iOS Orange
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #000; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .ios-card { background: #1C1C1E; border-radius: 18px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .ios-input { background: #2C2C2E; border: none; border-radius: 10px; padding: 12px; color: white; width: 100%; outline: none; }
        .ios-btn { border-radius: 12px; font-weight: 600; padding: 14px; transition: opacity 0.2s; }
        .ios-btn:active { opacity: 0.7; }
        
        /* Gráfico Donut CSS Puro - Indestructible */
        .pie-chart {
            width: 140px; height: 140px; border-radius: 50%;
            background: conic-gradient(var(--c1, #FF453A) var(--p1, 0%), var(--c2, #FF9F0A) 0 var(--p2, 0%), var(--c3, #30D158) 0 var(--p3, 100%));
            position: relative; margin: 0 auto;
        }
        .pie-hole {
            position: absolute; top: 20px; left: 20px; width: 100px; height: 100px;
            background: #1C1C1E; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 20px;
        }

        /* Pantalla de carga manual */
        #loading-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    
    <div id="loading-screen">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-white mx-auto mb-4"></div>
            <p class="text-gray-400 text-sm">Cargando Bóveda...</p>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, createContext, useContext } = React;

        // --- SISTEMA DE ICONOS ---
        const Icon = ({ name, size = 20, color = "white" }) => {
            useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size, color: color }}></i>;
        };

        // --- CONTEXTO (BASE DE DATOS) ---
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [txs, setTxs] = useState([]); // Transacciones

            // Login / Cargar
            const login = (password) => {
                try {
                    const encrypted = localStorage.getItem('family_db_v2');
                    if (!encrypted) {
                        setUser(password);
                        setTxs([]);
                        save([], password);
                        return true;
                    }
                    const bytes = CryptoJS.AES.decrypt(encrypted, password);
                    const data = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    setUser(password);
                    setTxs(data);
                    return true;
                } catch (e) {
                    return false;
                }
            };

            const save = (data, key = user) => {
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
                localStorage.setItem('family_db_v2', encrypted);
            };

            const addTx = (tx) => {
                const newTxs = [{ ...tx, id: Date.now() }, ...txs];
                setTxs(newTxs);
                save(newTxs);
            };

            const delTx = (id) => {
                const newTxs = txs.filter(t => t.id !== id);
                setTxs(newTxs);
                save(newTxs);
            };

            return (
                <AppContext.Provider value={{ user, login, txs, addTx, delTx }}>
                    {children}
                </AppContext.Provider>
            );
        };

        // --- VISTA 1: LOGIN ---
        const LoginScreen = () => {
            const { login } = useContext(AppContext);
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');

            const handleLogin = () => {
                if(pass.length < 4) return setErr("Mínimo 4 caracteres");
                if(!login(pass)) setErr("Contraseña incorrecta");
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-black">
                    <div className="w-20 h-20 bg-gray-900 rounded-3xl flex items-center justify-center mb-6 border border-gray-800">
                        <Icon name="lock" size={32} color="#0A84FF" />
                    </div>
                    <h1 className="text-3xl font-bold mb-2">FamilyWealth</h1>
                    <p className="text-gray-500 mb-8">Bóveda Privada Local</p>
                    
                    <div className="w-full max-w-sm space-y-4">
                        <input type="password" value={pass} onChange={e => setPass(e.target.value)} placeholder="Clave Maestra" className="ios-input text-center text-xl" />
                        {err && <p className="text-red-500 text-sm text-center">{err}</p>}
                        <button onClick={handleLogin} className="ios-btn bg-primary text-white w-full">Entrar</button>
                    </div>
                </div>
            );
        };

        // --- VISTA 2: DASHBOARD ---
        const Dashboard = () => {
            const { txs, addTx, delTx } = useContext(AppContext);
            const [tab, setTab] = useState('resumen');
            
            // Cálculos
            const totalIngresos = txs.filter(t => t.type === 'in').reduce((acc, t) => acc + t.amount, 0);
            const totalGastos = txs.filter(t => t.type === 'out').reduce((acc, t) => acc + t.amount, 0);
            const balance = totalIngresos - totalGastos;

            // Datos para Gráfico CSS
            const gastosCat = txs.filter(t => t.type === 'out').reduce((acc, t) => {
                acc[t.cat] = (acc[t.cat] || 0) + t.amount;
                return acc;
            }, { needs: 0, wants: 0, save: 0 });
            
            // Porcentajes para el gráfico Conic
            const totalG = totalGastos || 1;
            const p1 = (gastosCat.needs / totalG) * 100; // Necesidades (Rojo)
            const p2 = p1 + (gastosCat.wants / totalG) * 100; // Caprichos (Naranja)
            // El resto es Ahorro (Verde)

            return (
                <div className="pb-24 max-w-2xl mx-auto">
                    {/* HEADER */}
                    <div className="pt-10 pb-6 px-6 sticky top-0 bg-black/80 backdrop-blur-md z-10 border-b border-white/5">
                        <p className="text-gray-400 text-xs uppercase font-bold tracking-widest mb-1">Patrimonio Neto</p>
                        <h1 className="text-5xl font-bold">{balance.toFixed(2)}€</h1>
                    </div>

                    <div className="p-4 space-y-4">
                        
                        {/* 1. GRÁFICO GASTOS (CSS PURO) */}
                        <div className="ios-card flex items-center justify-between">
                            <div>
                                <h3 className="font-bold mb-4">Regla 50/30/20</h3>
                                <div className="space-y-2 text-xs">
                                    <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-danger"></div> Necesidades ({Math.round((gastosCat.needs/totalG)*100)}%)</div>
                                    <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-warning"></div> Caprichos ({Math.round((gastosCat.wants/totalG)*100)}%)</div>
                                    <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-success"></div> Ahorro ({Math.round((gastosCat.save/totalG)*100)}%)</div>
                                </div>
                            </div>
                            <div className="pie-chart" style={{
                                '--p1': `${p1}%`, 
                                '--p2': `${p2}%`, 
                                '--p3': '100%'
                            }}>
                                <div className="pie-hole">
                                    <Icon name="pie-chart" size={24} color="#555" />
                                </div>
                            </div>
                        </div>

                        {/* 2. AÑADIR RÁPIDO */}
                        <AddTransactionForm onAdd={addTx} />

                        {/* 3. SIMULADOR PRÉSTAMO */}
                        <LoanSimulator />

                        {/* 4. LISTA DE MOVIMIENTOS */}
                        <div className="ios-card">
                            <h3 className="font-bold mb-4 text-gray-400 text-sm">Últimos Movimientos</h3>
                            {txs.length === 0 ? <p className="text-center text-gray-600 text-sm py-4">Sin datos aún</p> : 
                            <div className="space-y-3">
                                {txs.slice(0, 10).map(t => (
                                    <div key={t.id} className="flex justify-between items-center border-b border-white/5 pb-2 last:border-0">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${t.type === 'in' ? 'bg-green-500/20' : 'bg-red-500/20'}`}>
                                                <Icon name={t.type === 'in' ? 'arrow-up' : 'arrow-down'} size={14} color={t.type === 'in' ? '#30D158' : '#FF453A'} />
                                            </div>
                                            <div>
                                                <div className="font-medium text-sm">{t.desc}</div>
                                                <div className="text-[10px] text-gray-500 uppercase">{t.cat}</div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <span className={t.type === 'in' ? 'text-green-500' : 'text-white'}>
                                                {t.type === 'in' ? '+' : '-'}{t.amount}€
                                            </span>
                                            <button onClick={() => delTx(t.id)} className="text-gray-600"><Icon name="trash-2" size={14}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTES AUXILIARES ---
        const AddTransactionForm = ({ onAdd }) => {
            const [form, setForm] = useState({ desc: '', amount: '', type: 'out', cat: 'needs' });
            
            const submit = () => {
                if(!form.desc || !form.amount) return;
                onAdd({ ...form, amount: parseFloat(form.amount) });
                setForm({ ...form, desc: '', amount: '' });
            };

            return (
                <div className="ios-card space-y-3">
                    <div className="flex gap-2 bg-gray-800 p-1 rounded-lg">
                        <button onClick={() => setForm({...form, type: 'in'})} className={`flex-1 py-1 text-sm rounded-md ${form.type === 'in' ? 'bg-green-600 text-white' : 'text-gray-400'}`}>Ingreso</button>
                        <button onClick={() => setForm({...form, type: 'out'})} className={`flex-1 py-1 text-sm rounded-md ${form.type === 'out' ? 'bg-red-600 text-white' : 'text-gray-400'}`}>Gasto</button>
                    </div>
                    <div className="flex gap-2">
                        <input placeholder="Concepto" value={form.desc} onChange={e => setForm({...form, desc: e.target.value})} className="ios-input flex-1" />
                        <input type="number" placeholder="€" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} className="ios-input w-24 text-center" />
                    </div>
                    {form.type === 'out' && (
                        <div className="flex justify-between text-xs pt-1">
                            {['needs', 'wants', 'save'].map(c => (
                                <label key={c} className={`cursor-pointer px-3 py-1 rounded-full border ${form.cat === c ? 'border-primary bg-primary/20 text-white' : 'border-gray-700 text-gray-500'}`}>
                                    <input type="radio" name="cat" className="hidden" onClick={() => setForm({...form, cat: c})} />
                                    {c === 'needs' ? 'Necesidad' : c === 'wants' ? 'Capricho' : 'Ahorro'}
                                </label>
                            ))}
                        </div>
                    )}
                    <button onClick={submit} className="w-full bg-white/10 hover:bg-white/20 py-3 rounded-xl text-sm font-bold mt-2">Registrar</button>
                </div>
            );
        };

        const LoanSimulator = () => {
            const [val, setVal] = useState(15000);
            const [months, setMonths] = useState(24);
            // Cálculo ING Directo
            const r = (5.50 / 100) / 12;
            const cuota = val * ((r * Math.pow(1+r, months)) / (Math.pow(1+r, months) - 1));

            return (
                <div className="ios-card bg-gray-900 border-orange-500/30 border">
                    <div className="flex justify-between items-start mb-4">
                        <h3 className="text-orange-500 font-bold flex items-center gap-2"><Icon name="calculator" size={16} color="#F97316"/> Simulador</h3>
                        <div className="text-right">
                            <div className="text-2xl font-bold text-white">{cuota.toFixed(2)}€</div>
                            <div className="text-[10px] text-gray-400">mensual</div>
                        </div>
                    </div>
                    <input type="range" min="1000" max="50000" step="1000" value={val} onChange={e => setVal(Number(e.target.value))} className="w-full mb-2 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer" />
                    <div className="flex justify-between text-xs text-gray-500 mb-4">
                        <span>{val}€</span>
                        <span>Solicitado</span>
                    </div>
                    <input type="range" min="12" max="84" step="6" value={months} onChange={e => setMonths(Number(e.target.value))} className="w-full mb-2 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer" />
                    <div className="flex justify-between text-xs text-gray-500">
                        <span>{months} meses</span>
                        <span>Plazo</span>
                    </div>
                </div>
            );
        };

        // --- INICIAR APP ---
        const App = () => {
            const { user } = useContext(AppContext);
            
            // Eliminar pantalla de carga cuando React monta
            useEffect(() => {
                const loader = document.getElementById('loading-screen');
                if(loader) loader.style.display = 'none';
            }, []);

            return user ? <Dashboard /> : <LoginScreen />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppProvider><App /></AppProvider>);
    </script>
</body>
</html>
