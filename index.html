<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FamilyWealth Ultimate Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #000; color: #f5f5f7; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, Helvetica, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* UI Components Estilo Premium */
        .ios-card { background: #1C1C1E; border-radius: 22px; padding: 20px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .ios-input { background: #2C2C2E; border: 1px solid #3A3A3C; border-radius: 12px; padding: 12px; color: white; width: 100%; outline: none; font-size: 15px; transition: all 0.2s; }
        .ios-input:focus { border-color: #0A84FF; background: #323234; }
        .ios-btn { border-radius: 14px; font-weight: 600; padding: 16px; transition: transform 0.1s, opacity 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .ios-btn:active { transform: scale(0.97); opacity: 0.8; }
        
        /* Efecto Plateado Premium para el Saldo */
        .silver-text {
            background: linear-gradient(180deg, #FFFFFF 0%, #A0A0A0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 2px 10px rgba(255,255,255,0.15);
        }

        /* Utility */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .emoji-btn { transition: all 0.2s; filter: grayscale(1); opacity: 0.5; transform: scale(0.9); }
        .emoji-btn.active { filter: grayscale(0); opacity: 1; transform: scale(1.1); background: rgba(255,255,255,0.1); border-radius: 12px; }
        
        /* Animaciones */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-enter { animation: slideUp 0.4s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, createContext, useContext, useRef } = React;

        // --- CONSTANTES ---
        const CATS = [
            { id: 'home', icon: 'üè†', label: 'Casa', color: 'text-blue-400' },
            { id: 'food', icon: 'üçî', label: 'Comida', color: 'text-orange-400' },
            { id: 'transport', icon: 'üöó', label: 'Auto', color: 'text-red-400' },
            { id: 'shop', icon: 'üõçÔ∏è', label: 'Compras', color: 'text-pink-400' },
            { id: 'fun', icon: 'üéâ', label: 'Ocio', color: 'text-purple-400' },
            { id: 'health', icon: 'üíä', label: 'Salud', color: 'text-green-400' },
            { id: 'bills', icon: 'üìÑ', label: 'Factura', color: 'text-yellow-400' },
            { id: 'misc', icon: 'üì¶', label: 'Otros', color: 'text-gray-400' }
        ];

        const Icon = ({ name, size = 18, className="" }) => {
            useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- CONTEXTO ---
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [data, setData] = useState({ txs: [], subs: [], goals: [] });

            const login = (password) => {
                try {
                    const encrypted = localStorage.getItem('fw_ultimate_pro_db');
                    if (!encrypted) {
                        const initial = { txs: [], subs: [], goals: [] };
                        setUser({ key: password }); setData(initial); save(initial, password);
                        return true;
                    }
                    const bytes = CryptoJS.AES.decrypt(encrypted, password);
                    const decrypted = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    
                    // Migraci√≥n segura
                    if(!decrypted.subs) decrypted.subs = [];
                    if(!decrypted.goals) decrypted.goals = [];
                    
                    setUser({ key: password }); setData(decrypted);
                    return true;
                } catch (e) { return false; }
            };

            const save = (newData, key = user?.key) => {
                if(!key) return;
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(newData), key).toString();
                localStorage.setItem('fw_ultimate_pro_db', encrypted);
            };

            const addItem = (type, item) => {
                const updated = { ...data, [type]: [{ ...item, id: Date.now() }, ...data[type]] };
                setData(updated); save(updated);
            };
            const delItem = (type, id) => {
                const updated = { ...data, [type]: data[type].filter(i => i.id !== id) };
                setData(updated); save(updated);
            };
            const updateItem = (type, updatedItem) => {
                const updatedList = data[type].map(i => i.id === updatedItem.id ? updatedItem : i);
                const updated = { ...data, [type]: updatedList };
                setData(updated); save(updated);
            };

            // FUNCIONES DE ARCHIVOS
            const exportData = () => {
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `FW_Backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const importData = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.txs) {
                            setData(json); save(json); alert("‚úÖ Datos cargados correctamente");
                        } else { alert("‚ö†Ô∏è Archivo incorrecto"); }
                    } catch (err) { alert("‚ùå Error al leer archivo"); }
                };
                reader.readAsText(file);
            };

            return (
                <AppContext.Provider value={{ user, login, data, addItem, delItem, updateItem, exportData, importData }}>
                    {children}
                </AppContext.Provider>
            );
        };

        // --- LOGIN ---
        const Login = () => {
            const { login } = useContext(AppContext);
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');
            return (
                <div className="h-screen flex flex-col items-center justify-center bg-black p-6">
                    <div className="w-20 h-20 bg-gray-900 rounded-3xl flex items-center justify-center mb-6 border border-gray-800 shadow-[0_0_30px_rgba(10,132,255,0.2)]">
                        <Icon name="wallet" size={36} className="text-blue-500" />
                    </div>
                    <h1 className="text-2xl font-bold mb-1 silver-text">FamilyWealth</h1>
                    <p className="text-gray-500 text-sm mb-8">Ultimate Pro</p>
                    <input type="password" value={pass} onChange={e=>setPass(e.target.value)} placeholder="Clave de Acceso" className="ios-input text-center text-xl mb-4 max-w-xs" />
                    <button onClick={() => pass.length > 3 ? (!login(pass) && setErr('Error')) : setErr('M√≠nimo 4')} className="ios-btn bg-blue-600 text-white w-full max-w-xs">Entrar</button>
                    {err && <p className="text-red-500 mt-4 text-xs">{err}</p>}
                </div>
            );
        };

        // --- COMPONENTE: AHORRO (GOALS) ---
        const SavingsGoals = () => {
            const { data, addItem, delItem } = useContext(AppContext);
            const [form, setForm] = useState({ name: '', target: '', current: '' });
            const [isOpen, setIsOpen] = useState(false);

            const handleAdd = () => {
                if(!form.name || !form.target) return;
                addItem('goals', { 
                    name: form.name, 
                    target: parseFloat(form.target), 
                    current: parseFloat(form.current) || 0 
                });
                setForm({name:'', target:'', current:''}); setIsOpen(false);
            };

            return (
                <div className="ios-card bg-gray-900 border border-yellow-500/30">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-yellow-500 font-bold flex items-center gap-2"><Icon name="piggy-bank" size={16}/> Metas Ahorro</h3>
                        <button onClick={()=>setIsOpen(!isOpen)} className="text-yellow-500 bg-yellow-500/10 p-2 rounded-lg text-xs font-bold">
                            {isOpen ? 'Cerrar' : '+ Crear'}
                        </button>
                    </div>

                    {isOpen && (
                        <div className="bg-black/40 p-3 rounded-xl mb-4 animate-enter border border-white/10">
                            <input placeholder="Nombre Meta (ej: Viaje)" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} className="ios-input text-xs mb-2"/>
                            <div className="flex gap-2">
                                <input type="number" placeholder="Objetivo ‚Ç¨" value={form.target} onChange={e=>setForm({...form, target:e.target.value})} className="ios-input text-xs"/>
                                <input type="number" placeholder="Ya tengo ‚Ç¨" value={form.current} onChange={e=>setForm({...form, current:e.target.value})} className="ios-input text-xs"/>
                            </div>
                            <button onClick={handleAdd} className="w-full mt-2 bg-yellow-600 text-black font-bold text-xs py-2 rounded-lg">Guardar Meta</button>
                        </div>
                    )}

                    <div className="space-y-4">
                        {data.goals.map(g => {
                            const percent = Math.min(100, (g.current / g.target) * 100);
                            return (
                                <div key={g.id} className="group">
                                    <div className="flex justify-between text-xs mb-1 text-gray-300">
                                        <span>{g.name}</span>
                                        <div className="flex gap-2">
                                            <span className="font-bold text-white">{g.current}‚Ç¨ / {g.target}‚Ç¨</span>
                                            <button onClick={()=>delItem('goals', g.id)} className="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="x" size={12}/></button>
                                        </div>
                                    </div>
                                    <div className="h-2 bg-gray-700 rounded-full overflow-hidden">
                                        <div style={{width: `${percent}%`}} className="bg-gradient-to-r from-yellow-600 to-yellow-400 h-full rounded-full transition-all duration-500"></div>
                                    </div>
                                </div>
                            )
                        })}
                        {data.goals.length === 0 && <p className="text-[10px] text-gray-500 text-center">Sin metas activas</p>}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: SUBSCRIPCIONES ---
        const SubscriptionManager = () => {
            const { data, addItem, delItem } = useContext(AppContext);
            const [form, setForm] = useState({ name: '', amount: '' });
            const [isOpen, setIsOpen] = useState(false);
            const totalMonthly = data.subs.reduce((acc, s) => acc + s.amount, 0);

            const handleAdd = () => {
                if(!form.name || !form.amount) return;
                addItem('subs', { name: form.name, amount: parseFloat(form.amount) });
                setForm({name:'', amount:''}); setIsOpen(false);
            };

            return (
                <div className="ios-card bg-gray-900 border border-purple-500/20">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <h3 className="text-purple-400 font-bold flex items-center gap-2"><Icon name="zap" size={16}/> Gastos Fijos</h3>
                        </div>
                        <div className="text-right">
                            <div className="text-white font-bold">{totalMonthly.toFixed(2)}‚Ç¨/mes</div>
                        </div>
                    </div>
                    {!isOpen ? (
                        <button onClick={()=>setIsOpen(true)} className="w-full py-2 bg-white/5 rounded-xl text-xs text-gray-400 hover:text-white mb-4">+ A√±adir</button>
                    ) : (
                        <div className="flex gap-2 mb-4 animate-enter">
                            <input placeholder="Nombre" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} className="ios-input text-xs py-2"/>
                            <input type="number" placeholder="‚Ç¨" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} className="ios-input w-20 text-xs py-2 text-center"/>
                            <button onClick={handleAdd} className="bg-purple-600 px-3 rounded-xl text-white"><Icon name="check" size={16}/></button>
                        </div>
                    )}
                    <div className="space-y-2">
                        {data.subs.map(s => (
                            <div key={s.id} className="flex justify-between items-center bg-black/20 p-2 rounded-lg group">
                                <span className="text-sm text-gray-300">{s.name}</span>
                                <div className="flex items-center gap-3">
                                    <span className="text-sm font-mono font-bold">{s.amount}‚Ç¨</span>
                                    <button onClick={()=>delItem('subs', s.id)} className="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash" size={12}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: SIMULADOR (CON INTER√âS MANUAL) ---
        const SmartSimulator = () => {
            const [amount, setAmount] = useState(15000);
            const [months, setMonths] = useState(48);
            const [rate, setRate] = useState(6.5);
            const [type, setType] = useState('auto');

            const presets = {
                home: { r: 3.5, label: 'Hipoteca', icon: 'home' },
                auto: { r: 6.5, label: 'Coche', icon: 'car' },
                card: { r: 12.0, label: 'Personal', icon: 'credit-card' }
            };

            const setPreset = (k) => {
                setType(k); setRate(presets[k].r);
                if(k === 'home') setMonths(300); if(k === 'auto') setMonths(48); if(k === 'card') setMonths(24);
            };

            const r = (rate / 100) / 12;
            const cuota = amount * ((r * Math.pow(1+r, months)) / (Math.pow(1+r, months) - 1));
            const totalPagado = cuota * months;
            const totalInteres = totalPagado - amount;
            const porcInteres = (totalInteres / totalPagado) * 100;

            return (
                <div className="ios-card bg-gray-900 border border-orange-500/30">
                    <h3 className="text-orange-500 font-bold mb-4 flex gap-2 items-center"><Icon name="calculator" size={16}/> Simulador</h3>
                    
                    {/* Botones R√°pidos */}
                    <div className="flex gap-2 mb-4 bg-black/40 p-1 rounded-xl">
                        {Object.entries(presets).map(([k, v]) => (
                            <button key={k} onClick={() => setPreset(k)} className={`flex-1 py-2 text-[10px] font-bold rounded-lg transition-all flex flex-col items-center gap-1 ${type === k ? 'bg-orange-500 text-white' : 'text-gray-500 hover:bg-white/5'}`}>
                                <Icon name={v.icon} size={14} /> {v.label}
                            </button>
                        ))}
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label className="text-[9px] text-gray-400 uppercase font-bold">Solicito (‚Ç¨)</label>
                            <input type="number" value={amount} onChange={e=>setAmount(Number(e.target.value))} className="ios-input text-center font-bold text-sm py-2"/>
                        </div>
                        <div>
                            <label className="text-[9px] text-gray-400 uppercase font-bold">Meses</label>
                            <input type="number" value={months} onChange={e=>setMonths(Number(e.target.value))} className="ios-input text-center font-bold text-sm py-2"/>
                        </div>
                    </div>

                    {/* INPUT DE INTER√âS MANUAL */}
                    <div className="mb-4">
                        <label className="text-[9px] text-gray-400 uppercase font-bold">Inter√©s Anual (%)</label>
                        <div className="flex items-center gap-2">
                             <input type="number" value={rate} onChange={e=>{setRate(Number(e.target.value)); setType('custom');}} className="ios-input text-center font-bold text-sm py-2 text-orange-400 border-orange-500/20"/>
                             <span className="text-xs text-gray-500">{type === 'custom' ? '(Manual)' : '(Auto)'}</span>
                        </div>
                    </div>

                    <div className="bg-black/40 p-3 rounded-xl text-center mb-2 border border-white/5">
                        <p className="text-[10px] text-gray-400 mb-1">Cuota Mensual</p>
                        <p className="text-2xl font-bold text-white">{cuota.toFixed(2)}‚Ç¨</p>
                    </div>

                    <div className="mt-3">
                        <div className="h-2 bg-gray-800 rounded-full overflow-hidden flex">
                            <div style={{width: `${100-porcInteres}%`}} className="bg-green-500 h-full"></div>
                            <div style={{width: `${porcInteres}%`}} className="bg-red-500 h-full"></div>
                        </div>
                        <div className="flex justify-between text-[9px] mt-1 text-gray-500">
                            <span>Capital</span>
                            <span>Intereses ({totalInteres.toFixed(0)}‚Ç¨)</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD PRINCIPAL ---
        const Dashboard = () => {
            const { data, addItem, delItem, exportData, importData } = useContext(AppContext);
            const [form, setForm] = useState({ desc: '', amount: '', type: 'out', catId: 'food' });
            const fileRef = useRef(null);

            const income = data.txs.filter(t => t.type === 'in').reduce((acc, t) => acc + t.amount, 0);
            const expense = data.txs.filter(t => t.type === 'out').reduce((acc, t) => acc + t.amount, 0);
            const balance = income - expense;

            const submit = () => {
                if(!form.desc || !form.amount) return;
                const catInfo = CATS.find(c => c.id === form.catId) || CATS[7];
                addItem('txs', { ...form, amount: parseFloat(form.amount), catIcon: catInfo.icon, catLabel: catInfo.label });
                setForm({ ...form, desc: '', amount: '' });
            };

            return (
                <div className="pb-32 max-w-xl mx-auto min-h-screen">
                    {/* Header con Texto en Nubes */}
                    <nav className="p-6 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur-md z-20 border-b border-white/5">
                        <span className="text-lg font-bold">FamilyWealth</span>
                        <div className="flex gap-2">
                            <button onClick={()=>fileRef.current.click()} className="flex items-center gap-1 bg-gray-800 px-3 py-2 rounded-full text-[10px] font-bold text-blue-400 hover:bg-gray-700 transition">
                                <Icon name="upload-cloud" size={14}/> <span>Importar</span>
                            </button>
                            <button onClick={exportData} className="flex items-center gap-1 bg-gray-800 px-3 py-2 rounded-full text-[10px] font-bold text-green-400 hover:bg-gray-700 transition">
                                <Icon name="download-cloud" size={14}/> <span>Exportar</span>
                            </button>
                            <input type="file" ref={fileRef} onChange={e => e.target.files[0] && importData(e.target.files[0])} className="hidden" accept=".json"/>
                        </div>
                    </nav>

                    {/* Balance Plateado */}
                    <div className="px-6 py-8 text-center">
                        <p className="text-gray-500 text-xs font-bold uppercase tracking-widest mb-2">Patrimonio Neto</p>
                        <h1 className="text-6xl font-bold silver-text mb-2 tracking-tight">{balance.toFixed(2)}‚Ç¨</h1>
                        <div className="flex justify-center gap-4 text-xs font-mono">
                            <span className="text-green-500 bg-green-900/20 px-2 py-1 rounded">+{income}</span>
                            <span className="text-red-500 bg-red-900/20 px-2 py-1 rounded">-{expense}</span>
                        </div>
                    </div>

                    <div className="px-4 space-y-4">
                        
                        {/* INPUT PRINCIPAL */}
                        <div className="ios-card bg-gray-900/80 backdrop-blur border-blue-500/20 border">
                            <div className="flex gap-2 mb-4 bg-black/40 p-1 rounded-xl">
                                <button onClick={() => setForm({...form, type: 'in'})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${form.type === 'in' ? 'bg-green-600 text-white' : 'text-gray-500'}`}>INGRESO</button>
                                <button onClick={() => setForm({...form, type: 'out'})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${form.type === 'out' ? 'bg-red-600 text-white' : 'text-gray-500'}`}>GASTO</button>
                            </div>

                            <div className="flex gap-3 mb-4">
                                <input placeholder="Concepto" value={form.desc} onChange={e => setForm({...form, desc: e.target.value})} className="ios-input flex-1" />
                                <input type="number" placeholder="0.00" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} className="ios-input w-24 text-center" />
                            </div>

                            {form.type === 'out' && (
                                <div className="mb-4">
                                    <p className="text-[10px] text-gray-500 uppercase font-bold mb-2">Categor√≠a</p>
                                    <div className="flex justify-between overflow-x-auto hide-scroll pb-2 gap-2">
                                        {CATS.map(c => (
                                            <button key={c.id} onClick={() => setForm({...form, catId: c.id})} className={`emoji-btn flex flex-col items-center gap-1 p-2 min-w-[50px] ${form.catId === c.id ? 'active' : ''}`}>
                                                <span className="text-2xl">{c.icon}</span>
                                                <span className="text-[9px] text-gray-400">{c.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <button onClick={submit} className="ios-btn w-full bg-white text-black hover:bg-gray-200">Registrar</button>
                        </div>

                        {/* AHORRO (NUEVO) */}
                        <SavingsGoals />

                        {/* M√ìDULOS EXTRA */}
                        <SubscriptionManager />
                        <SmartSimulator />

                        {/* HISTORIAL */}
                        <div className="ios-card">
                            <h3 className="text-xs uppercase font-bold text-gray-500 mb-4">Actividad Reciente</h3>
                            <div className="space-y-4">
                                {data.txs.slice(0, 8).map(t => (
                                    <div key={t.id} className="flex justify-between items-center group animate-enter">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-white/5 rounded-full flex items-center justify-center text-xl">
                                                {t.type === 'in' ? 'üí∞' : (t.catIcon || 'üí∏')}
                                            </div>
                                            <div>
                                                <p className="font-medium text-sm text-gray-200">{t.desc}</p>
                                                <p className="text-[10px] text-gray-500 uppercase">{t.catLabel || 'General'}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <span className={`font-mono font-bold ${t.type === 'in' ? 'text-green-400' : 'text-white'}`}>
                                                {t.type === 'in' ? '+' : '-'}{t.amount.toFixed(2)}‚Ç¨
                                            </span>
                                            <button onClick={() => delItem('txs', t.id)} className="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="x" size={14}/></button>
                                        </div>
                                    </div>
                                ))}
                                {data.txs.length === 0 && <p className="text-center text-gray-600 text-sm py-4">Todo limpio ‚ú®</p>}
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppProvider><AppContext.Consumer>{({user}) => user ? <Dashboard/> : <Login/>}</AppContext.Consumer></AppProvider>);
    </script>
</body>
</html>
